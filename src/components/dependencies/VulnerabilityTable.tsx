"use client";

import {
  Box,
  Flex,
  Input,
  Text,
  Table,
  Badge,
  Button,
  HStack,
} from "@chakra-ui/react";
import { FaExternalLinkAlt } from "react-icons/fa";

type Vulnerability = {
  id: string;
  severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  summary: string;
  fixedVersion?: string;
};

type VulnerabilityWithPackage = Vulnerability & {
  packageName: string;
  packageVersion: string;
};

type Props = {
  vulnerabilities: VulnerabilityWithPackage[];
  selectedId?: string;
  onSelect?: (vuln: VulnerabilityWithPackage) => void;
};

const SEVERITY_COLORS = {
  CRITICAL: "#f85149",
  HIGH: "#db6d28",
  MEDIUM: "#d29922",
  LOW: "#238636",
};

function SeverityBadge({
  severity,
}: {
  severity: keyof typeof SEVERITY_COLORS;
}) {
  return (
    <Badge
      bg={SEVERITY_COLORS[severity]}
      color="white"
      px={2}
      py={1}
      borderRadius="md"
      fontSize="xs"
    >
      {severity}
    </Badge>
  );
}

export function VulnerabilityTable({
  vulnerabilities,
  selectedId,
  onSelect,
}: Props) {
  return (
    <Box>
      {/* Header with title + search */}
      <Flex justify="space-between" align="center" mb={4}>
        <Text fontSize="xl" fontWeight="bold" color="#c9d1d9">
          Vulnerabilities ({vulnerabilities.length})
        </Text>
        <Input
          placeholder="Search..."
          maxW="300px"
          bg="#0d1117"
          border="1px solid #30363d"
          color="#c9d1d9"
          _placeholder={{ color: "#6e7681" }}
          _focus={{ borderColor: "#58a6ff" }}
        />
      </Flex>

      {/* Table */}
      <Box overflowX="auto" borderRadius="lg" border="1px solid #30363d">
        <Table.Root size="sm">
          <Table.Header>
            <Table.Row bg="#161b22">
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Severity
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Package
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                ID
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Summary
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Fix
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Actions
              </Table.ColumnHeader>
            </Table.Row>
          </Table.Header>
          <Table.Body>
            {vulnerabilities.map((vuln, idx) => (
              <Table.Row
                key={`${vuln.id}-${idx}`}
                bg={selectedId === vuln.id ? "#21262d" : "#0d1117"}
                _hover={{ bg: "#21262d" }}
                transition="background 0.2s"
                cursor="pointer"
                onClick={() => onSelect?.(vuln)}
              >
                <Table.Cell borderColor="#30363d">
                  <SeverityBadge severity={vuln.severity} />
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#c9d1d9"
                  fontFamily="mono"
                  fontSize="sm"
                >
                  {vuln.packageName}@{vuln.packageVersion}
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#58a6ff"
                  fontFamily="mono"
                  fontSize="sm"
                >
                  {vuln.id}
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#8b949e"
                  maxW="300px"
                  truncate
                >
                  {vuln.summary}
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#238636"
                  fontFamily="mono"
                  fontSize="sm"
                >
                  {vuln.fixedVersion || "-"}
                </Table.Cell>
                <Table.Cell borderColor="#30363d">
                  <HStack gap={2}>
                    <a
                      href={`https://osv.dev/vulnerability/${vuln.id}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <Button
                        size="xs"
                        variant="outline"
                        borderColor="#30363d"
                        color="#8b949e"
                        _hover={{ bg: "#21262d", color: "#c9d1d9" }}
                      >
                        <FaExternalLinkAlt />
                      </Button>
                    </a>
                  </HStack>
                </Table.Cell>
              </Table.Row>
            ))}
          </Table.Body>
        </Table.Root>
      </Box>
    </Box>
  );
}
